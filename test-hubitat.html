<!DOCTYPE html>
<html>
<head>
    <title>Test Hubitat API</title>
</head>
<body>
    <h1>Test Hubitat API</h1>
    <p><strong>Por que n√£o podemos testar direto do navegador:</strong></p>
    <ul>
        <li>Seu app roda em <code>dashboard-fernando-livia.pages.dev</code></li>
        <li>A API do Hubitat est√° em <code>cloud.hubitat.com</code></li>
        <li>CORS bloqueia requisi√ß√µes entre dom√≠nios diferentes</li>
        <li>Por isso usamos Cloudflare Functions como proxy</li>
    </ul>
    <p><strong>Arquitetura Atual (Correta):</strong></p>
    <ol>
        <li>Navegador ‚Üí <code>/polling</code> (mesmo dom√≠nio ‚úÖ)</li>
        <li>Cloudflare Function ‚Üí <code>cloud.hubitat.com</code> (servidor para servidor ‚úÖ)</li>
        <li>Cloudflare Function ‚Üí Navegador (resposta JSON ‚úÖ)</li>
    </ol>
    <p><strong>Por que funciona:</strong> As Cloudflare Functions rodam no servidor, n√£o no navegador, ent√£o n√£o t√™m restri√ß√µes de CORS.</p>
    <button onclick="testPolling()">Test /polling Function</button>
    <button onclick="testDenonMetadata()">Test Denon Metadata Extraction</button>
    <pre id="result"></pre>

    <script>
        async function testPolling() {
            const result = document.getElementById('result');
            result.textContent = 'Fetching from /polling...';
            
            try {
                const response = await fetch('/polling?full=1');
                const text = await response.text();
                
                result.textContent = `Status: ${response.status}\n`;
                result.textContent += `Content-Type: ${response.headers.get('content-type')}\n\n`;
                result.textContent += `Response (first 1000 chars):\n${text.substring(0, 1000)}`;
                
                // Try to parse as JSON
                try {
                    const json = JSON.parse(text);
                    result.textContent += `\n\n‚úÖ Valid JSON!`;
                    result.textContent += `\nData: ${JSON.stringify(json, null, 2).substring(0, 500)}`;
                } catch (e) {
                    result.textContent += `\n\n‚ùå Not valid JSON: ${e.message}`;
                }
            } catch (error) {
                result.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function testDenonMetadata() {
            const result = document.getElementById('result');
            result.textContent = 'Testing Denon metadata extraction...';
            
            try {
                const response = await fetch('/polling?full=1');
                const text = await response.text();
                
                result.textContent = `Status: ${response.status}\n\n`;
                
                // Try to parse as JSON
                try {
                    const json = JSON.parse(text);
                    result.textContent += `‚úÖ Valid JSON!\n\n`;
                    
                    // Find Denon device (ID 326)
                    const denonDevice = json.find(device => device.id === 326 || device.id === "326");
                    
                    if (denonDevice) {
                        result.textContent += `üéµ Denon device found: ${denonDevice.name} (ID: ${denonDevice.id})\n\n`;
                        result.textContent += `Atributos dispon√≠veis: ${Object.keys(denonDevice.attributes || {}).join(', ')}\n\n`;
                        
                        const attrs = denonDevice.attributes || {};
                        const trackDataRaw = attrs.trackData || attrs.playbackSource;
                        
                        result.textContent += `trackData bruto: ${trackDataRaw}\n\n`;
                        
                        // Try to parse trackData
                        let trackData = null;
                        if (trackDataRaw) {
                            try {
                                trackData = JSON.parse(trackDataRaw);
                                result.textContent += `‚úÖ trackData parseado:\n${JSON.stringify(trackData, null, 2)}\n\n`;
                                
                                // Extract metadata
                                const artist = trackData.artist || trackData.albumArtist || "Desconhecido";
                                const song = trackData.song || trackData.title || trackData.track || "Sem t√≠tulo";
                                const album = trackData.album || trackData.station || "√Ålbum desconhecido";
                                const image = trackData.image_url || trackData.albumArt || null;
                                
                                result.textContent += `üéµ Metadados extra√≠dos:\n`;
                                result.textContent += `  Artista: ${artist}\n`;
                                result.textContent += `  M√∫sica: ${song}\n`;
                                result.textContent += `  √Ålbum: ${album}\n`;
                                result.textContent += `  Imagem: ${image}\n`;
                                
                            } catch (parseError) {
                                result.textContent += `‚ùå Erro ao parsear trackData: ${parseError.message}\n`;
                            }
                        } else {
                            result.textContent += `‚ùå Nenhum trackData encontrado nos atributos\n`;
                        }
                        
                    } else {
                        result.textContent += `‚ùå Denon device (ID 326) n√£o encontrado\n\n`;
                        result.textContent += `Dispositivos dispon√≠veis:\n`;
                        json.forEach(device => {
                            result.textContent += `  - ID ${device.id}: ${device.name}\n`;
                        });
                    }
                    
                } catch (e) {
                    result.textContent += `‚ùå Not valid JSON: ${e.message}\n\n`;
                    result.textContent += `Raw response: ${text.substring(0, 500)}`;
                }
            } catch (error) {
                result.textContent = `‚ùå Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
