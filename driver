/**
 *  MolSmart GW3 Driver - IR(SendIR) SIMPLIFICADO para Ar Condicionado
 *  Versão com apenas comandos essenciais: ON, OFF, Swing ON/OFF, Temperaturas 18-25°C
 *
 *  Copyright 2024 VH 
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
 *  in compliance with the License. You may obtain a copy of the License at:
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed
 *  on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License
 *  for the specific language governing permissions and limitations under the License.
 *
 *  Versão Simplificada - Apenas comandos essenciais
 *  Comandos: ON, OFF, Swing ON, Swing OFF, 18-25°C
*/

metadata {
  definition (name: "MolSmart GW3 - IR(SendIR) Simplificado", namespace: "TRATO", author: "VH", vid: "generic-contact") {
    capability "Switch"
    capability "Sensor"
    capability "Actuator"
    capability "Configuration"
    capability "Refresh"
    capability "PushableButton"

    attribute "acMode", "STRING"

    command "commandON"
    command "commandOFF"
    command "swingON"
    command "swingOFF"
    command "setTemp18"
    command "setTemp19"
    command "setTemp20"
    command "setTemp21"
    command "setTemp22"
    command "setTemp23"
    command "setTemp24"
    command "setTemp25"
  }
}

import groovy.transform.Field
@Field static final String DRIVER = "by TRATO - Versão Simplificada"

preferences {
  input name: "molIPAddress", type: "text", title: "MolSmart GW3 IP Address", required: true, defaultValue: "192.168.1.100"
  input name: "serialNum", title: "Numero de serie (Etiqueta GW3)", type: "string", defaultValue: "111111"
  input name: "verifyCode", title: "Verify code (Etiqueta GW3)", type: "string", defaultValue: "111111"
  input name: "channel", title: "Canal Infravermelho (1/2 ou 3)", type: "string", defaultValue: "1"
  
  input name: "irON", type: "text", title: "Código IR - ON", required: false
  input name: "irOFF", type: "text", title: "Código IR - OFF", required: false
  input name: "irSwingON", type: "text", title: "Código IR - Swing ON", required: false
  input name: "irSwingOFF", type: "text", title: "Código IR - Swing OFF", required: false
  input name: "irTemp18", type: "text", title: "Código IR - Temperatura 18°C", required: false
  input name: "irTemp19", type: "text", title: "Código IR - Temperatura 19°C", required: false
  input name: "irTemp20", type: "text", title: "Código IR - Temperatura 20°C", required: false
  input name: "irTemp21", type: "text", title: "Código IR - Temperatura 21°C", required: false
  input name: "irTemp22", type: "text", title: "Código IR - Temperatura 22°C", required: false
  input name: "irTemp23", type: "text", title: "Código IR - Temperatura 23°C", required: false
  input name: "irTemp24", type: "text", title: "Código IR - Temperatura 24°C", required: false
  input name: "irTemp25", type: "text", title: "Código IR - Temperatura 25°C", required: false
  
  input name: "logEnable", type: "bool", title: "Enable debug logging", defaultValue: false
}

def configure() {
  log.debug "configure()"
}

def installed() {
  sendEvent(name: "numberOfButtons", value: 10)
  log.debug "installed()"
  off()
  setdefaults()
}

def updated() {
  log.debug "updated()"
  setdefaults()
  off()
  AtualizaDadosGW3()
}

// Get Device info and set as state to use during driver
def AtualizaDadosGW3() {
  state.currentip = settings.molIPAddress
  state.serialNum = settings.serialNum
  state.verifyCode = settings.verifyCode
  state.channel = settings.channel
  
  // Armazenar os códigos IR das preferences
  state.OnIRsend = settings.irON
  state.OFFIRsend = settings.irOFF
  state.SwingONIRsend = settings.irSwingON
  state.SwingOFFIRsend = settings.irSwingOFF
  state.Temp18IRsend = settings.irTemp18
  state.Temp19IRsend = settings.irTemp19
  state.Temp20IRsend = settings.irTemp20
  state.Temp21IRsend = settings.irTemp21
  state.Temp22IRsend = settings.irTemp22
  state.Temp23IRsend = settings.irTemp23
  state.Temp24IRsend = settings.irTemp24
  state.Temp25IRsend = settings.irTemp25
  
  log.info "GW3 Dados atualizados - IP: ${state.currentip}, Serial: ${state.serialNum}"
}

// Armazenar códigos IR das Preferences é feito automaticamente em AtualizaDadosGW3()


// Default values
def setdefaults() {
  sendEvent(name: "acMode", value: "OFF", descriptionText: "AC Mode set to OFF")
  sendEvent(name: "switch", value: "off")
  log.debug "Defaults set"
}

// Comandos principais
def on() {
  log.info "Ligando AC..."
  sendEvent(name: "switch", value: "on")
  sendEvent(name: "acMode", value: "ON")
  def ircode = state.OnIRsend
  EnviaComando(ircode)
}

def off() {
  log.info "Desligando AC..."
  sendEvent(name: "switch", value: "off")
  sendEvent(name: "acMode", value: "OFF")
  def ircode = state.OFFIRsend
  EnviaComando(ircode)
}

def commandON() {
  on()
}

def commandOFF() {
  off()
}

def swingON() {
  log.info "Ativando Swing..."
  sendEvent(name: "acMode", value: "Swing ON")
  def ircode = state.SwingONIRsend
  EnviaComando(ircode)
}

def swingOFF() {
  log.info "Desativando Swing..."
  sendEvent(name: "acMode", value: "Swing OFF")
  def ircode = state.SwingOFFIRsend
  EnviaComando(ircode)
}

def setTemp18() {
  log.info "Setando temperatura para 18°C"
  sendEvent(name: "acMode", value: "18°C")
  def ircode = state.Temp18IRsend
  EnviaComando(ircode)
}

def setTemp19() {
  log.info "Setando temperatura para 19°C"
  sendEvent(name: "acMode", value: "19°C")
  def ircode = state.Temp19IRsend
  EnviaComando(ircode)
}

def setTemp20() {
  log.info "Setando temperatura para 20°C"
  sendEvent(name: "acMode", value: "20°C")
  def ircode = state.Temp20IRsend
  EnviaComando(ircode)
}

def setTemp21() {
  log.info "Setando temperatura para 21°C"
  sendEvent(name: "acMode", value: "21°C")
  def ircode = state.Temp21IRsend
  EnviaComando(ircode)
}

def setTemp22() {
  log.info "Setando temperatura para 22°C"
  sendEvent(name: "acMode", value: "22°C")
  def ircode = state.Temp22IRsend
  EnviaComando(ircode)
}

def setTemp23() {
  log.info "Setando temperatura para 23°C"
  sendEvent(name: "acMode", value: "23°C")
  def ircode = state.Temp23IRsend
  EnviaComando(ircode)
}

def setTemp24() {
  log.info "Setando temperatura para 24°C"
  sendEvent(name: "acMode", value: "24°C")
  def ircode = state.Temp24IRsend
  EnviaComando(ircode)
}

def setTemp25() {
  log.info "Setando temperatura para 25°C"
  sendEvent(name: "acMode", value: "25°C")
  def ircode = state.Temp25IRsend
  EnviaComando(ircode)
}

// Enviar comando via HTTP POST
def EnviaComando(command) {
  if (!command) {
    log.warn "Nenhum código IR configurado"
    return
  }

  def URI = "http://" + state.currentip + "/api/device/deviceDetails/smartHomeAutoHttpControl?serialNum=" + state.serialNum + "&verifyCode=" + state.verifyCode + "&c=" + state.channel + "&gc=" + command

  try {
    httpPost(URI.replaceAll(' ', '%20'), "") { resp ->
      if (resp.data) {
        log.info "Resposta: ${resp.data}"
      }
    }
    log.info "Comando enviado: ${URI}"
  } catch (Exception e) {
    log.error "Erro ao enviar comando: ${e.message}"
  }
}

def parse(String description) {
  logDebug "$description"
}

private logDebug(msg) {
  if (settings?.logEnable) {
    log.debug "$msg"
  }
}
